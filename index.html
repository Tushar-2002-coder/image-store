<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Step-by-step Secure Equipment QR Generator — Buttons Only + Safe Inputs</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Poppins:wght@500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
<style>
  :root{
    --bg: #f8fbff;
    --card: #fd9d5c;
    --muted: #4b5563;
    --accent1: #0ea5a4;
    --accent2: #06b6d4;
    --glass: rgba(2,6,23,0.03);
    --success: #059669;
    --danger: #ef4444;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, Poppins, system-ui;background:linear-gradient(180deg,#fbfdff 0%, #eef6ff 100%);color:#04263a;-webkit-font-smoothing:antialiased}
  .wrap{max-width:820px;margin:28px auto;padding:20px;border-radius:16px;position:relative}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:18px}
  .badge{width:100px;height:50px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-family:Poppins;font-size:18px;box-shadow:0 10px 30px rgba(2,6,23,0.06)}
  h1{margin:0;font-size:20px}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  .main{display:flex;gap:18px}
  .left{flex:1;min-width:300px}
  .right{width:260px;display:flex;flex-direction:column;align-items:flex-end;gap:10px}

  /* Stepper slides */
  .card{background:var(--card);border-radius:12px;padding:18px;border:1px solid rgba(2,6,23,0.06);box-shadow:0 12px 40px rgba(2,6,23,0.04)}
  .slides{height:150px;display:flex;overflow:hidden;position:relative;border-radius:10px}
  .slidesInner{display:flex;width:100%;transition:transform .45s cubic-bezier(.2,.9,.2,1)}
  .slide{min-width:100%;padding:22px;display:flex;flex-direction:column;justify-content:flex-start;align-items:stretch;gap:8px}
  .label{font-size:14px;color:#062331;font-weight:700;margin-bottom:6px}
  .sublabel{font-size:12px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="date"], textarea{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(2,6,23,0.06);background:var(--glass);font-size:15px;outline:none;transition:box-shadow .12s}
  textarea{min-height:96px;resize:vertical}
  input:focus, textarea:focus{box-shadow:0 10px 30px rgba(6,182,212,0.08);border-color:rgba(6,182,212,0.18)}

  .controls{display:flex;align-items:center;gap:10px;margin-top:12px}
  .btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;color:white;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer;box-shadow:0 12px 36px rgba(2,6,23,0.06)}
  .btn.secondary{background:transparent;border:1px solid rgba(2,6,23,0.06);color:var(--muted);font-weight:600}
  .btn:active{transform:translateY(1px)}

  .progress{display:flex;gap:8px;justify-content:center;margin-top:12px}
  .dot{width:10px;height:10px;border-radius:50%;background:rgba(2,6,23,0.06);transition:transform .18s,background .18s}
  .dot.active{background:linear-gradient(90deg,var(--accent1),var(--accent2));transform:scale(1.18)}

  /* right side clear button and meta */
  .clearWrap{display:flex;flex-direction:column;align-items:flex-end;gap:10px}
  .clearBtn{background:transparent;border:1px solid rgba(2,6,23,0.06);padding:8px 12px;border-radius:10px;color:var(--muted);cursor:pointer;font-weight:600}
  .note{font-size:13px;color:var(--muted);text-align:right}

  /* QR box */
  .qrBox{margin-top:18px;background:linear-gradient(180deg,#ffffff,#f5fbff);border-radius:12px;padding:24px;border:1px solid rgba(2,6,23,0.06);display:flex;flex-direction:column;align-items:center;gap:12px;min-height:220px;justify-content:center;position:relative;overflow:hidden}
  .qrCanvas{width:280px;height:280px;border-radius:8px;background:transparent;display:flex;align-items:center;justify-content:center;transition:transform .35s}
  .qrCanvas.pop{transform:scale(1.06);box-shadow:0 30px 80px rgba(6,182,212,0.08)}

  .downloadBtn{margin-left:90px;background:#0b1220;color:white;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}

  /* spray animation elements */
  .spray{position:absolute;pointer-events:none;z-index:40;left:0;right:0;top:0;bottom:0;overflow:visible}
  .spray .piece{position:absolute;width:10px;height:12px;border-radius:4px;opacity:0.95;transform-origin:center;animation:fall 1000ms ease-out forwards}
  @keyframes fall{0%{transform:translateY(-20px) rotate(0) scale(1);opacity:1}100%{transform:translateY(260px) rotate(720deg) scale(.6);opacity:0}}

  /* small helpers */
  .muted{color:var(--muted);font-size:13px}
  .hint{font-size:12px;color:var(--muted);margin-top:6px;text-align:center}
  .kbd{display:inline-block;padding:6px 8px;border-radius:8px;background:#f3f9ff;border:1px solid rgba(2,6,23,0.04);font-weight:700}

  /* swipe cursor */
  .slides:active{cursor:grabbing}

  @media (max-width:880px){ .main{flex-direction:column} .right{align-items:flex-start;width:100%} .clearWrap{align-items:flex-start} .qrBox{min-height:200px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="badge">EQ</div>
      <div>
        <h1>Equipment QR Generator</h1>
        <p class="lead">Fill equipment details one-by-one. Use the Next/Previous buttons or swipe to navigate.</p>
      </div>
    </div>

    <div class="main">
      <div class="left card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-weight:700">Enter details</div>
          <div class="muted">Buttons + Swipe only</div>
        </div>

        <div class="slides" id="slides" aria-label="Stepper slides">
          <div class="slidesInner" id="slidesInner" role="list">
            <!-- Slides (one per field) with explicit labels above inputs -->
            <div class="slide" role="listitem" data-field="equipment_name">
              <div class="label">Equipment Name</div>
              <div class="sublabel">Enter the common name of the equipment</div>
              <input id="equipment_name" class="no-propagate" type="text" placeholder="Shell & Tube Heat Exchanger" autocomplete="off" />
            </div>

            <div class="slide" role="listitem" data-field="tag_no">
              <div class="label">Tag Number</div>
              <div class="sublabel">Unique tag or identifier</div>
              <input id="tag_no" class="no-propagate" type="text" placeholder="E-101 / P-204" autocomplete="off" />
            </div>

            <div class="slide" role="listitem" data-field="location">
              <div class="label">Location / Area</div>
              <div class="sublabel">Where the equipment is installed</div>
              <input id="location" class="no-propagate" type="text" placeholder="Plant A - Section 5" autocomplete="off" />
            </div>

            <div class="slide" role="listitem" data-field="material_of_construction">
              <div class="label">Material of Construction (MOC)</div>
              <div class="sublabel">Main materials like SS316, CS etc.</div>
              <input id="material_of_construction" class="no-propagate" type="text" placeholder="SS316" autocomplete="off" />
            </div>

            <div class="slide" role="listitem" data-field="capacity">
              <div class="label">Capacity</div>
              <div class="sublabel">Capacity or throughput (units)</div>
              <input id="capacity" class="no-propagate" type="text" placeholder="5 m³ or 5000 L" autocomplete="off" />
            </div>

            <div class="slide" role="listitem" data-field="working_pressure">
              <div class="label">Working Pressure</div>
              <div class="sublabel">Operating pressure (e.g., 6 bar)</div>
              <input id="working_pressure" class="no-propagate" type="text" placeholder="6 bar" autocomplete="off" />
            </div>

            <div class="slide" role="listitem" data-field="working_temperature">
              <div class="label">Working Temperature</div>
              <div class="sublabel">Typical operating temperature</div>
              <input id="working_temperature" class="no-propagate" type="text" placeholder="120 °C" autocomplete="off" />
            </div>

            <div class="slide" role="listitem" data-field="manufacturer">
              <div class="label">Manufacturer</div>
              <div class="sublabel">Equipment maker</div>
              <input id="manufacturer" class="no-propagate" type="text" placeholder="ABC Equipments Ltd." autocomplete="off" />
            </div>

            <div class="slide" role="listitem" data-field="purchase_date">
              <div class="label">Date of Purchase</div>
              <div class="sublabel">Purchase / commissioning date</div>
              <input id="purchase_date" class="no-propagate" type="date" />
            </div>

            <div class="slide" role="listitem" data-field="last_maintenance">
              <div class="label">Last Maintenance Date</div>
              <div class="sublabel">Most recent maintenance</div>
              <input id="last_maintenance" class="no-propagate" type="date" />
            </div>

            <div class="slide" role="listitem" data-field="next_maintenance">
              <div class="label">Next Scheduled Maintenance</div>
              <div class="sublabel">Planned next maintenance</div>
              <input id="next_maintenance" class="no-propagate" type="date" />
            </div>

            <div class="slide" role="listitem" data-field="notes">
              <div class="label">Notes / Additional Info</div>
              <div class="sublabel">Special instructions, spare parts, etc.</div>
              <textarea id="notes" class="no-propagate" placeholder="Spare parts, special instructions..."></textarea>
            </div>
          </div>
        </div>

        <div class="progress" id="progress" aria-hidden="true"></div>

        <div style="display:flex;justify-content:center;gap:10px;margin-top:14px">
          <button id="prevBtn" class="btn" aria-label="Previous">Previous</button>
          <button id="nextBtn" class="btn" aria-label="Next">Next</button>
        </div>

        <div class="hint">Use <strong>Previous</strong> / <strong>Next</strong> buttons to navigate. You can also swipe left/right. Tapping slides will <strong>not</strong> advance.</div>
      </div>

      <div class="right">
        <div class="clearWrap">
          <button id="clearBtn" class="btn" aria-label="Clear All">Clear All</button>
          <div class="note">Click Clear to reset all fields and the QR.</div>
        </div>

        <div class="card qrBox" id="qrBox" aria-live="polite">
          <div class="qrCanvas" id="qrcanvasWrap">
            <div class="muted">No QR generated yet</div>
          </div>
        </div>
        
        
          <div style="display:flex;gap:30px">
            <button id="generateBtn" class="btn">Generate QR</button>
            <button id="downloadBtn" class="downloadBtn" disabled>Download QR</button>
          </div>

          <div class="hint muted">Generated QR stores encrypted equipment details. Keep password safe.</div>
        
          <div class="spray" id="spray"></div>
      </div>
    </div>
  </div>

<script>
// Helper crypto (AES-GCM + PBKDF2)
function str2ab(str){ return new TextEncoder().encode(str); }
function ab2str(buf){ return new TextDecoder().decode(buf); }
function ab2b64(buf){ const bytes=new Uint8Array(buf); let s=''; const CH=0x8000; for(let i=0;i<bytes.length;i+=CH) s+=String.fromCharCode.apply(null, bytes.subarray(i,i+CH)); return btoa(s); }
function b642ab(b64){ const bin=atob(b64); const u8=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i); return u8.buffer; }

async function deriveKey(pass, salt){
  const base = await crypto.subtle.importKey('raw', str2ab(pass), {name:'PBKDF2'}, false, ['deriveKey']);
  return crypto.subtle.deriveKey({name:'PBKDF2', salt: salt, iterations:150000, hash:'SHA-256'}, base, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
}
async function encryptJson(jsonString, pass){
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const key = await deriveKey(pass, salt);
  const ct = await crypto.subtle.encrypt({ name:'AES-GCM', iv: iv }, key, str2ab(jsonString));
  return { v:1, salt: ab2b64(salt.buffer), iv: ab2b64(iv.buffer), ct: ab2b64(ct) };
}

// Stepper logic
const slidesInner = document.getElementById('slidesInner');
const slideEls = Array.from(document.querySelectorAll('.slide'));
const progressEl = document.getElementById('progress');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
let idx = 0;

// Build progress dots
slideEls.forEach((s,i)=>{
  const d = document.createElement('div');
  d.className = 'dot' + (i===0?' active':'');
  progressEl.appendChild(d);
});

function updateSlides(){
  slidesInner.style.transition = 'transform .45s cubic-bezier(.2,.9,.2,1)';
  slidesInner.style.transform = `translateX(${-idx*100}%)`;
  Array.from(progressEl.children).forEach((d,i)=> d.classList.toggle('active', i===idx) );
  prevBtn.disabled = (idx===0);
  if(idx === slideEls.length-1){
    nextBtn.textContent = 'Generate QR';
  } else {
    nextBtn.textContent = 'Next';
  }
}

// Removed Enter/key auto-advance and any click-to-advance handlers.
// Now ONLY buttons and swipe control navigation.

prevBtn.addEventListener('click', ()=>{ if(idx>0){ idx--; updateSlides(); } });
nextBtn.addEventListener('click', ()=>{ if(idx < slideEls.length-1){ idx++; updateSlides(); } else { onGenerateClick(); } });

// Swipe support (touch) — but ignore swipes that start from inputs/textareas
let startX=0, currentX=0, isDown=false;
const slides = document.getElementById('slides');
slides.addEventListener('touchstart', (e)=>{
  // if the touch started on an input/textarea, don't begin swipe
  const target = e.target;
  if(target.closest && target.closest('.no-propagate')) return;
  isDown=true; startX = e.touches[0].clientX; slidesInner.style.transition = '';
});
slides.addEventListener('touchmove', (e)=>{
  if(!isDown) return;
  const target = e.target;
  if(target.closest && target.closest('.no-propagate')) return;
  currentX = e.touches[0].clientX; const dx = currentX - startX; slidesInner.style.transform = `translateX(${ -idx*100 + (dx / slides.clientWidth)*100 }%)`;
});
slides.addEventListener('touchend', (e)=>{
  if(!isDown) return;
  const target = e.target;
  if(target.closest && target.closest('.no-propagate')) { isDown=false; return; }
  isDown=false; const dx = currentX - startX; if(dx < -50 && idx < slideEls.length-1) idx++; else if(dx > 50 && idx > 0) idx--; updateSlides(); startX=0; currentX=0;
});

// Also prevent mouse-based drag from starting on inputs
slides.addEventListener('mousedown', (e)=>{
  const target = e.target;
  if(target.closest && target.closest('.no-propagate')) return;
  isDown=true; startX = e.clientX; slidesInner.style.transition = '';
});
document.addEventListener('mousemove', (e)=>{
  if(!isDown) return;
  const target = e.target;
  if(target.closest && target.closest('.no-propagate')) return;
  currentX = e.clientX; slidesInner.style.transform = `translateX(${ -idx*100 + (currentX - startX) / slides.clientWidth * 100 }%)`;
});
document.addEventListener('mouseup', (e)=>{
  if(!isDown) return;
  const target = e.target;
  if(target.closest && target.closest('.no-propagate')) { isDown=false; return; }
  isDown=false; const dx = currentX - startX; if(dx < -50 && idx < slideEls.length-1) idx++; else if(dx > 50 && idx > 0) idx--; updateSlides(); startX=0; currentX=0;
});

// Clear action
const clearBtn = document.getElementById('clearBtn');
const allFieldIds = ['equipment_name','tag_no','location','material_of_construction','capacity','working_pressure','working_temperature','manufacturer','purchase_date','last_maintenance','next_maintenance','notes'];
const downloadBtn = document.getElementById('downloadBtn');
clearBtn.addEventListener('click', ()=>{ allFieldIds.forEach(id=> { const el=document.getElementById(id); if(el) el.value=''; }); idx = 0; updateSlides(); clearQR(); downloadBtn.disabled = true; delete downloadBtn.dataset.uri; delete downloadBtn.dataset.name; });

// Generate QR
const generateBtn = document.getElementById('generateBtn');
const qrcanvasWrap = document.getElementById('qrcanvasWrap');
async function onGenerateClick(){
  const obj = {};
  allFieldIds.forEach(id=> { const el=document.getElementById(id); obj[id] = el ? el.value || '' : ''; });
  let pass = prompt('Enter passphrase to encrypt this equipment data (keep it safe):');
  if(pass === null) return;
  pass = String(pass);
  try{
    const json = JSON.stringify(obj);
    const encrypted = await encryptJson(json, pass);
    const payload = JSON.stringify(encrypted);
    qrcanvasWrap.innerHTML = '';
    const cvs = document.createElement('canvas');
    cvs.width = 520; cvs.height = 520;
    cvs.style.width = '200px'; cvs.style.height = '200px';
    qrcanvasWrap.appendChild(cvs);
    await QRCode.toCanvas(cvs, payload, { width: 520, margin: 2, errorCorrectionLevel: 'M' });
    qrcanvasWrap.classList.add('pop');
    setTimeout(()=> qrcanvasWrap.classList.remove('pop'), 900);
    downloadBtn.disabled = false;
    downloadBtn.dataset.uri = cvs.toDataURL('image/png');
    downloadBtn.dataset.name = `equipment-qr-${(obj.equipment_name||'equipment').replace(/\s+/g,'_').replace(/[^\w\\-_.]/g,'')}.png`;
    playSprayAnimation();
  }catch(err){
    console.error(err); alert('Failed to generate QR: '+ (err.message||err));
  }
}
document.getElementById('generateBtn').addEventListener('click', onGenerateClick);

// Download QR
downloadBtn.addEventListener('click', ()=>{
  const uri = downloadBtn.dataset.uri;
  const name = downloadBtn.dataset.name || 'equipment-qr.png';
  if(!uri){ alert('No QR to download'); return; }
  const a = document.createElement('a');
  a.href = uri;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});

function clearQR(){
  qrcanvasWrap.innerHTML = '<div class="muted">No QR generated yet</div>';
  downloadBtn.disabled = true;
  delete downloadBtn.dataset.uri;
  delete downloadBtn.dataset.name;
}

// Spray animation
function playSprayAnimation(){
  const colors = ['#0ea5a4','#06b6d4','#f59e0b','#fb7185','#34d399','#7c3aed'];
  const count = 20;
  const rect = qrcanvasWrap.getBoundingClientRect();
  for(let i=0;i<count;i++){
    const p = document.createElement('div');
    p.className = 'piece';
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    const cx = rect.left + rect.width/2 + (Math.random()*80 - 40);
    const cy = rect.top + rect.height/2 + (Math.random()*40 - 20);
    p.style.left = cx + 'px';
    p.style.top = cy + 'px';
    p.style.position = 'fixed';
    p.style.transform = `translateY(-20px) rotate(${Math.random()*360}deg)`;
    p.style.width = (6 + Math.random()*10) + 'px';
    p.style.height = (8 + Math.random()*12) + 'px';
    p.style.borderRadius = (Math.random()*4) + 'px';
    p.style.zIndex = 9999;
    p.style.opacity = '1';
    document.body.appendChild(p);
    setTimeout(()=> { try{ p.style.transform = `translateY(${220 + Math.random()*120}px) rotate(${360 + Math.random()*720}deg) scale(${0.6 + Math.random()*0.6})`; p.style.opacity='0'; }catch(e){} }, 20 + Math.random()*120);
    setTimeout(()=> { try{ document.body.removeChild(p); }catch(e){} }, 1200 + Math.random()*400);
  }
}

// Initialize
updateSlides();
clearQR();

// Keyboard: arrow navigation only, Enter won't advance
document.addEventListener('keydown', (e)=>{
  if(e.key === 'ArrowRight') { if(idx < slideEls.length-1){ idx++; updateSlides(); } else { onGenerateClick(); } }
  if(e.key === 'ArrowLeft') { if(idx>0){ idx--; updateSlides(); } }
});

// Prevent clicks on inputs from bubbling to slides (extra safety)
document.querySelectorAll('.no-propagate').forEach(el=>{
  ['click','mousedown','mouseup','touchstart','touchmove','touchend'].forEach(ev=>{
    el.addEventListener(ev, (e)=>{ e.stopPropagation(); });
  });
});

</script>
</body>
</html>
